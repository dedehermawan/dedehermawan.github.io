<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Api | Dede Hermawan]]></title>
  <link href="http://dedehermawan.github.io/blog/categories/api/atom.xml" rel="self"/>
  <link href="http://dedehermawan.github.io/"/>
  <updated>2018-08-01T11:26:14+07:00</updated>
  <id>http://dedehermawan.github.io/</id>
  <author>
    <name><![CDATA[Dede Hermawan]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Autentikasi Di Rails Dengan JWT]]></title>
    <link href="http://dedehermawan.github.io/blog/2018/07/27/autentikasi-di-rails-dengan-jwt/"/>
    <updated>2018-07-27T08:17:06+07:00</updated>
    <id>http://dedehermawan.github.io/blog/2018/07/27/autentikasi-di-rails-dengan-jwt</id>
    <content type="html"><![CDATA[<p>Sudah lama ni saya tidak update blog saya ini, ya mungkin karena saya tidak pandai dalam hal menulis blog sih hhe..</p>

<p>Oke untuk sekarang ini saya akan mencoba menulis tentang membuat aplikasi web berbasis <strong>api</strong> menggunakan rails. Disini saya akan sekaligus membuat aplikasi api terkait autentikasi menggunakan gem <a href="https://jwt.io">JWT</a>.<br/>
Oke langsung saja kita membuat proyek rails app nya
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails new auth_jwt &ndash;api -T -d postgresql</span></code></pre></td></tr></table></div></figure>
Setelah proyek selesai di generate langsung saja masuk ke direktori app tersebut &ldquo;<strong>auth_jwt</strong>&rdquo;.</p>

<p>Selanjutnya  kita buat model <strong>User</strong> untuk kepentingan autentikasi, disini kita gunakan atribut email dan password _digest sebagai dasar dari model User
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails g model user email password_digest
</span><span class='line'>rake db:migrate</span></code></pre></td></tr></table></div></figure></p>

<h2>Validation</h2>

<p>Untuk proses create user kita tambahkan validasi pada model <strong>app/model/user.rb</strong>
<code>ruby
class User &lt; ApplicationRecord
  validates_presence_of :email
  validates_uniqueness_of :email, case_sensitive: false
  validates_format_of :email, with: /@/
</code></p>

<h2>Hash password</h2>

<p>Untuk hash password kita gunakan gem &lsquo;<strong>bcrypt</strong>&rsquo;, silakan kamu tambahkan gem &lsquo;bcrypt&rsquo; di file <strong>Gemfile</strong>
<code>ruby
...
gem 'bcrypt'
...
</code>
lalu tambahkan sintak dibawah ini pada <strong>app/model/user.rb</strong>
<code>ruby
class User &lt; ApplicationRecord
  has_secure_password
  ...
</code>
Supaya format email berupa huruf kecil semua dan menghilangkan spasi pada email, kita buat <em>callback</em> method di <strong>app/model/user.rb</strong>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span>
</span><span class='line'>  <span class="n">before_save</span> <span class="ss">:downcase_email</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  def downcase_email</span>
</span><span class='line'><span class="sr">    self.email = self.email.delete(&amp;lsquo; &amp;rsquo;).downcase</span>
</span><span class='line'><span class="sr">  end</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>User create</h2>

<p>Sekarang kita akan buat endpoint untuk method user create
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails g controller users</span></code></pre></td></tr></table></div></figure>
tambahkan sintak di bawah ini di <strong>config/routes.rb</strong>
<code>ruby
resources :users, only: :create
</code>
Selanjutnya kita buat method create di <strong>app/controllers/users_controller.rb</strong>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  if user.save</span>
</span><span class='line'><span class="sr">    render json: {status: &amp;lsquo;User created successfully&amp;rsquo;}, status: :created</span>
</span><span class='line'><span class="sr">  else</span>
</span><span class='line'><span class="sr">    render json: {errors: user.errors.full_messages}, status: :bad_request</span>
</span><span class='line'><span class="sr">  end</span>
</span><span class='line'><span class="sr">end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="kp">private</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;def user_params</span>
</span><span class='line'><span class="sr">  params.require(:user).permit(:email, :password, :password_confirmation)</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure>
Sekarang coba kamu buat user dengan mengirimkan request <strong>POST</strong> ke alamat <a href="http://localhost:3000/users">http://localhost:3000/users</a> menggunakan curl di terminal
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -d &lsquo;{&ldquo;user&rdquo;: {&ldquo;email&rdquo;: &ldquo;&lt;a href="&#109;&#x61;&#105;&#x6c;&#x74;&#x6f;&#58;&#116;&#x65;&#x73;&#x74;&#64;&#x65;&#x6d;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#116;&#101;&#115;&#116;&#64;&#101;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#x63;&#x6f;&#109;&lt;/a>&rdquo;, &ldquo;password&rdquo;: &ldquo;12345&rdquo;, &ldquo;password_confirmation&rdquo;: &ldquo;12345&rdquo;}}&rsquo; -H &ldquo;Content-Type: application/json&rdquo; -X POST &lt;a href="http://localhost:3000/users">http://localhost:3000/users&lt;/a></span></code></pre></td></tr></table></div></figure>
Jika respon yang dihasilkan adalah seperti dibawah ini, berarti proses create user kamu berhasil
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{&ldquo;status&rdquo;:&ldquo;User created successfully&rdquo;}</span></code></pre></td></tr></table></div></figure></p>

<h2>Confirmation</h2>

<p>Disini kita akan membuat proses konfirmasi email mungkin tidak terlalu kompleks tetapi bisa mewakili proses konfirmasi itu sendiri, proses konfirmasi ini di perlukan apabila waktu mau login tetapi email belum di verifikasi maka user tidak akan bisa login.</p>

<p>Oke pertama-tama kita buat migration untuk menambahkan atribut pada model user / field pada tabel users
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails g migration add_confirmation_email_to_users confirmation_token confirmed_at:date confirmation_sent_at:date
</span><span class='line'>rake db:migrate</span></code></pre></td></tr></table></div></figure>
tambahkan <em>callback</em> method <strong>generate_confirmation_instructions</strong> di <strong>app/model/user.rb</strong>, untuk menggenerate berupa string random pada field confirmation_token dan menggenerate waktu pada saat user itu di create pada field confirmation_sent_at.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span>
</span><span class='line'>  <span class="n">before_create</span> <span class="ss">:generate_confirmation_instructions</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  &amp;hellip;</span>
</span><span class='line'><span class="sr">  &amp;hellip;</span>
</span><span class='line'><span class="sr">  def generate_confirmation_instructions</span>
</span><span class='line'><span class="sr">    self.confirmation_token = SecureRandom.hex(10)</span>
</span><span class='line'><span class="sr">    self.confirmation_sent_at = Time.now.utc</span>
</span><span class='line'><span class="sr">  end</span>
</span><span class='line'><span class="sr">&lt;code&gt;</span>
</span><span class='line'><span class="sr">Sekarang kita tambahkan routes **confirm** pada **config/</span><span class="n">routes</span><span class="o">**</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;ruby</span>
</span><span class='line'><span class="sr">resources :users, only: :create do</span>
</span><span class='line'><span class="sr">  collection do</span>
</span><span class='line'><span class="sr">    post &amp;lsquo;confirm&amp;rsquo;</span>
</span><span class='line'><span class="sr">  end</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;code&gt;</span>
</span><span class='line'><span class="sr">Lalu kita buat method **confirm** di **users_controller.rb**</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;</span><span class="n">ruby</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span>
</span><span class='line'><span class="k">def</span> <span class="nf">confirm</span>
</span><span class='line'>  <span class="n">token</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">].</span><span class="n">to_s</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  user = User.find_by(confirmation_token: token)&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">present</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">user</span><span class="o">.</span><span class="n">confirmation_token_valid?</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">mark_as_confirmed!</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="p">{</span><span class="ss">status</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="no">User</span> <span class="n">confirmed</span> <span class="n">successfully</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;},</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:ok</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="p">{</span><span class="ss">status</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="no">Invalid</span> <span class="n">token</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;},</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:not_found</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>
Oke sekarang kita coba proses confirm di atas dengan mengirimkan POST ke url <strong>localhost:3000/users/confirm</strong> dengan di sertakan data <strong>token</strong> berdasarkan isi dari field <strong>confirmation_token</strong>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -d &lsquo;{&ldquo;token&rdquo; = &ldquo;1c2c2aea02e3b03fd0e1&rdquo;}&rsquo; -H &ldquo;Content-Type: application/json&rdquo; -X POST &lt;a href="http://localhost:3000/users/confirm">http://localhost:3000/users/confirm&lt;/a></span></code></pre></td></tr></table></div></figure>
Apabila muncul keterangan seperti dibawah ini berarti proses konfirmasi berhasil
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{&ldquo;status&rdquo;:&ldquo;User confirmed successfully&rdquo;}</span></code></pre></td></tr></table></div></figure></p>
]]></content>
  </entry>
  
</feed>
